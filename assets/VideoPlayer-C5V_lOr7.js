import{c as ce,al as oe,r as S,ca as ye,w as j,o as ve,j as Se,aq as se,m as y,n as c,p as u,_ as me,cb as be,bF as he,z as s,h as k,t as Ve,R as we,e as ke,am as xe,W as Fe,q as d,s as te,v as H,B as R,E as h,a3 as Ne,G as T,ae as Ce,F as ae,C as ue,V as le,aK as Ie,Y as $e,x as Pe,Z as Re,$ as De,as as de,H as Q,a6 as Le}from"./index-BIGEKVTp.js";const _e={class:"canvas-container"},Me=["width","height"],X=100,Te=60,ze=ce({__name:"VideoPlayerStatsForNerds",props:{width:{type:Number,default:130},height:{type:Number,default:200},updateInterval:{type:Number,default:20},streamName:{type:String,default:""}},setup(V){const D=oe(),r=V,x=S(null),i=S([]),F=S([]),a=S([]);let n=null,I=null,p=0,f=0,L=0,N=0,v=0,b=0,m=0,O=0,z=!1,W=0,q=0,G=0,Y=0,K=0,_=0,Z=0,U=0,A=1e3,o=30,e=10,l=120;function $(C,t){return C/t*Te}function ne(){const t=x.value.getContext("2d"),{width:g,height:P}=r;t.clearRect(0,0,g,P);function B(M,ee,ge){t.strokeStyle=ee,t.lineWidth=1,t.beginPath();for(let E=0;E<M.length;E++){const ie=E/(X-1)*g,re=P-$(M[E],ge);E===0?t.moveTo(ie,re):t.lineTo(ie,re)}t.stroke()}B(F.value,"rgb(255, 165, 0)",A),B(i.value,"rgb(0, 255, 0)",o),B(a.value,"rgb(255, 0, 0)",e);const w=z?"red":"white",fe=[{label:"Stream",value:r.streamName,color:w},{label:"Size",value:U?`${U}p`:"N/A",color:w},{label:"Packets Lost",value:`${f} (${K.toFixed(0)}%)`,color:w},{label:"Frame drops",value:Y,color:w},{label:"Nack",value:v,color:w},{label:"Pli",value:b,color:w},{label:"Fir",value:m,color:w},{label:"Processing ",value:`${W.toFixed(0)}ms`,color:w},{label:"Freezes",value:`${q}(${G.toFixed(1)}s)`,color:w},{label:"Bitrate",value:`${p.toFixed(0)}kbps`,color:"rgb(255, 165, 0)"},{label:"FPS",value:_.toFixed(2),color:"rgb(0, 255, 0)"}];t.font="10px Arial",fe.forEach((M,ee)=>{t.fillStyle=M.color,t.fillText(`${M.label}: ${M.value}`,5,12+ee*12)}),n=requestAnimationFrame(ne)}const J=new ye({getStatsInterval:100});function pe(){i.value.push(_),F.value.push(p),a.value.push(Math.min(Z,e)),i.value.length>X&&i.value.shift(),F.value.length>X&&F.value.shift(),a.value.length>X&&a.value.shift(),A=Math.max(A,...F.value),o=Math.max(o,...i.value),o=Math.min(o,l)}return j(D.activeStreams,C=>{Object.keys(C).forEach(t=>{var P;if(t!==r.streamName)return;const g=(P=C[t])==null?void 0:P.webRtcManager.session;!g||!g.peerConnection||J.peersToMonitor[g.consumerId]||J.addConnection({pc:g.peerConnection,peerId:g.consumerId,connectionId:g.id,remote:!1})})}),ve(()=>{I=setInterval(pe,r.updateInterval),ne(),J.on("stats",C=>{try{const t=C.data.video.inbound[0];if(t===void 0)return;if(z=t.bitrate===0,!isNaN(t.bitrate)){const B=t.bitrate/1e3;p=p*.8+B*.2}Z=t.packetsLost-f,f=t.packetsLost,v=t.nackCount,b=t.pliCount,m=t.firCount,L=t.packetsReceived;let g=t.totalProcessingDelay-N,P=t.framesReceived-O;W=1e3*g/P,O=t.framesReceived,N=t.totalProcessingDelay,K=f/(f+L)*100,q=t.freezeCount,G=t.totalFreezesDuration,Y=t.framesDropped,_=t.framesPerSecond??0,U=t.frameHeight}catch(t){console.error(t)}})}),Se(()=>{clearInterval(I),cancelAnimationFrame(n)}),se(()=>{J.destroy()}),(C,t)=>(c(),y("div",_e,[u("canvas",{ref_key:"canvasRef",ref:x,width:V.width,height:V.height},null,8,Me)]))}}),Ue=me(ze,[["__scopeId","data-v-4a8ba759"]]);function Ae(V){const D=oe(),r=i=>{i&&D.acquireStream(i)},x=i=>{i&&D.releaseStream(i)};ve(()=>r(V.value)),j(V,(i,F)=>{x(F),r(i)}),se(()=>x(V.value))}const Be=be("v-banner-text"),Ee={ref:"videoWidget",class:"video-widget"},He={key:1,class:"no-video-alert"},je={key:2,class:"no-video-alert"},Oe={key:0,class:"loading-overlay"},We={key:0,class:"success-icon mb-4"},qe={class:"loading-text"},Ge={key:2,class:"verbose-status"},Ye={class:"status-line"},Ke={class:"status-line"},Ze={class:"flex-wrap justify-center d-flex ga-5"},Je=ce({__name:"VideoPlayer",props:{widget:{}},setup(V){he(o=>({"1ceaf346":G.value,"4a05c60e":s(a).options.videoFitStyle}));const D=we(),r=oe(),x=ke(),{namessAvailableAbstractedStreams:i}=xe(r),a=Ve(V).widget,n=S(),I=S(),p=S(),f=S(!1),L=S(!1),N=S(!1),v=S(!1);let b=null;Fe(()=>{const o={videoFitStyle:"cover",flipHorizontally:!1,flipVertically:!1,rotationAngle:0,statsForNerds:!1,internalStreamName:void 0,showVerboseLoading:!1};a.value.options={...o,...a.value.options},n.value=a.value.options.internalStreamName});const m=k(()=>n.value?r.externalStreamId(n.value):void 0);Ae(m),j(()=>r.streamsCorrespondency,()=>{if(p.value=void 0,!n.value)return;const o=r.externalStreamId(n.value);if(!o)return;const e=r.streamsCorrespondency.find($=>$.externalId===o);if(!e)return;const l=e.name;n.value!==l&&(n.value=l,a.value.options.internalStreamName=l)},{deep:!0});const O=setInterval(()=>{var o;if(a.value.options.internalStreamName===void 0&&!i.value.isEmpty()&&(a.value.options.internalStreamName=i.value[0],n.value=a.value.options.internalStreamName),m.value!==void 0){const e=r.getMediaStream(m.value);e!==p.value&&(p.value=e);const l=((o=r.getStreamData(m.value))==null?void 0:o.connected)??!1;l!==f.value&&(f.value=l)}if(!i.value.isEmpty()&&!i.value.includes(n.value)){if(r.lastRenamedStreamName!==""){n.value=r.lastRenamedStreamName;return}n.value=i.value[0]}},1e3);se(()=>{clearInterval(O),b&&clearTimeout(b)}),j(n,()=>{a.value.options.internalStreamName=n.value,p.value=void 0,N.value=!1,v.value=!1,b&&clearTimeout(b)}),j(p,()=>{if(!I.value||!p.value){N.value=!1,v.value=!1;return}I.value.srcObject=p.value,I.value.play().then(()=>{console.log("[VideoPlayer] Stream is playing"),N.value=!0,v.value=!0,b&&clearTimeout(b),b=setTimeout(()=>{v.value=!1},1e3)}).catch(o=>{const e=`Failed to play stream. Reason: ${o}`;console.error(`[VideoPlayer] ${e}`),N.value=!1,v.value=!1})});const z=o=>{a.value.options.rotationAngle+=o},W=k(()=>`scale(${a.value.options.flipHorizontally?-1:1}, ${a.value.options.flipVertically?-1:1})`),q=k(()=>`rotate(${a.value.options.rotationAngle??0}deg)`),G=k(()=>`${W.value} ${q.value}`),Y=k(()=>{var o;return m.value===void 0?"Unknown.":((o=r.getStreamData(m.value))==null?void 0:o.webRtcManager.signallerStatus)??"Unknown."}),K=k(()=>{var e;if(m.value===void 0)return"Unknown.";const o=r.availableIceIps;return!o.isEmpty()&&!o.find(l=>r.allowedIceIps.includes(l))?`Stream is coming from IPs [${o.join(", ")}], which are not in the list of allowed sources
      [${r.allowedIceIps.join(", ")}].\\n Please check your configuration.`:((e=r.getStreamData(m.value))==null?void 0:e.webRtcManager.streamStatus)??"Unknown."}),_=k(()=>a.value.options.showVerboseLoading||L.value),Z=k(()=>n.value===void 0||!i.value.includes(n.value)?!1:v.value?!0:!N.value),U=k(()=>{const o=n.value?`'${n.value} (${m.value??"unknown"})'`:"";return v.value?"Stream loaded":(f.value?"Loading":"Connecting to")+` stream ${o}`}),A=()=>{L.value=!L.value};return(o,e)=>(c(),y(ae,null,[u("div",Ee,[s(a).options.statsForNerds?(c(),te(Ue,{key:0,"stream-name":m.value},null,8,["stream-name"])):H("",!0),n.value===void 0?(c(),y("div",He,e[9]||(e[9]=[u("span",null,"No video stream selected.",-1)]))):!s(i).isEmpty()&&!s(i).includes(n.value)?(c(),y("div",je,[u("p",null,'The selected stream "'+R(n.value)+'" is not available.',1),u("p",null,"Available ones are: "+R(s(i).map(l=>`"${l}"`).join(", "))+".",1),e[10]||(e[10]=u("br",null,null,-1)),e[11]||(e[11]=u("p",null," This can happen if you changed vehicles and the stream name in the new one is different from the former, or if the source is not available at all. ",-1)),e[12]||(e[12]=u("br",null,null,-1)),e[13]||(e[13]=u("p",null," Please open this video player configuration and select a new stream from the ones available, or check your source for issues. ",-1))])):H("",!0),d(Ie,{name:"loading-complete"},{default:h(()=>[Z.value?(c(),y("div",Oe,[v.value?(c(),y("div",We,[d(Ne,{size:"48",color:"white"},{default:h(()=>e[14]||(e[14]=[T("mdi-check-circle")])),_:1,__:[14]})])):(c(),te(Ce,{key:1,indeterminate:"",color:"white",size:"48",width:"3",class:"mb-4"})),u("p",qe,R(U.value),1),_.value&&!f.value&&!v.value?(c(),y("div",Ge,[u("p",Ye,[e[15]||(e[15]=u("span",{class:"status-label"},"Server: ",-1)),(c(!0),y(ae,null,ue(Y.value.toString().split("\\n"),(l,$)=>(c(),y("span",{key:"server-"+$},R(l),1))),128))]),u("p",Ke,[e[16]||(e[16]=u("span",{class:"status-label"},"Stream: ",-1)),(c(!0),y(ae,null,ue(K.value.toString().split("\\n"),(l,$)=>(c(),y("span",{key:"stream-"+$},R(l),1))),128))])])):H("",!0),!f.value&&!v.value?(c(),te(le,{key:3,variant:"text",size:"small",class:"mt-3 toggle-details-btn",onClick:A},{default:h(()=>[T(R(_.value?"Hide details":"Show details"),1)]),_:1})):H("",!0)])):H("",!0)]),_:1}),u("video",{id:"mainDisplayStream",ref_key:"videoElement",ref:I,muted:"",autoplay:"",playsinline:"",disablePictureInPicture:""}," Your browser does not support the video tag. ",512)],512),d(Le,{modelValue:s(x).widgetManagerVars(s(a).hash).configMenuOpen,"onUpdate:modelValue":e[8]||(e[8]=l=>s(x).widgetManagerVars(s(a).hash).configMenuOpen=l),width:"auto"},{default:h(()=>[d($e,{class:"pa-4 text-white",style:Pe([{"border-radius":"15px"},s(D).globalGlassMenuStyles])},{default:h(()=>[d(Re,{class:"text-center"},{default:h(()=>e[17]||(e[17]=[T("Video widget config")])),_:1,__:[17]}),d(De,{class:"flex flex-col gap-y-4"},{default:h(()=>[d(de,{modelValue:n.value,"onUpdate:modelValue":e[0]||(e[0]=l=>n.value=l),label:"Stream name",class:"my-3",items:s(i),"item-title":"name",density:"compact",variant:"outlined","no-data-text":"No streams available.","hide-details":"","return-object":""},null,8,["modelValue","items"]),d(de,{modelValue:s(a).options.videoFitStyle,"onUpdate:modelValue":e[1]||(e[1]=l=>s(a).options.videoFitStyle=l),label:"Fit style",class:"my-3",items:["cover","fill","contain"],"item-title":"style",density:"compact",variant:"outlined","no-data-text":"No streams available.","hide-details":"","return-object":""},null,8,["modelValue"]),d(Be,null,{default:h(()=>[T('Saved stream name: "'+R(s(a).options.internalStreamName)+'"',1)]),_:1}),d(Q,{modelValue:s(a).options.flipHorizontally,"onUpdate:modelValue":e[2]||(e[2]=l=>s(a).options.flipHorizontally=l),class:"my-1",label:"Flip horizontally",color:s(a).options.flipHorizontally?"white":void 0,"hide-details":""},null,8,["modelValue","color"]),d(Q,{modelValue:s(a).options.flipVertically,"onUpdate:modelValue":e[3]||(e[3]=l=>s(a).options.flipVertically=l),class:"my-1",label:"Flip vertically",color:s(a).options.flipVertically?"white":void 0,"hide-details":""},null,8,["modelValue","color"]),d(Q,{modelValue:s(a).options.statsForNerds,"onUpdate:modelValue":e[4]||(e[4]=l=>s(a).options.statsForNerds=l),class:"my-1",label:"Stats for nerds",color:s(a).options.statsForNerds?"white":void 0,"hide-details":""},null,8,["modelValue","color"]),d(Q,{modelValue:s(a).options.showVerboseLoading,"onUpdate:modelValue":e[5]||(e[5]=l=>s(a).options.showVerboseLoading=l),class:"my-1",label:"Verbose loading status",color:s(a).options.showVerboseLoading?"white":void 0,"hide-details":""},null,8,["modelValue","color"]),u("div",Ze,[d(le,{"prepend-icon":"mdi-file-rotate-left",variant:"outlined",onClick:e[6]||(e[6]=l=>z(-90))},{default:h(()=>e[18]||(e[18]=[T(" Rotate Left")])),_:1,__:[18]}),d(le,{"prepend-icon":"mdi-file-rotate-right",variant:"outlined",onClick:e[7]||(e[7]=l=>z(90))},{default:h(()=>e[19]||(e[19]=[T(" Rotate Right")])),_:1,__:[19]})])]),_:1})]),_:1},8,["style"])]),_:1},8,["modelValue"])],64))}}),Xe=me(Je,[["__scopeId","data-v-868e7a7d"]]);export{Xe as default};
